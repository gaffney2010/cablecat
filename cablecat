#!/bin/bash

SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
CONFIG_FILE="/usr/lib/cablecat/apps.json"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: Config file not found at $CONFIG_FILE"
    exit 1
fi

# Extract ASCII art from README (lines 2-6, between the code fences)
ASCII_ART=$(sed -n '2,6p' "$SCRIPT_DIR/README.md")

# Get app names for fzf
APP_NAMES=$(jq -r '.apps[].name' "$CONFIG_FILE")

# Show fzf with ASCII art header
SELECTED=$(echo "$APP_NAMES" | fzf --header="$ASCII_ART" --header-first)

if [ -z "$SELECTED" ]; then
    exit 0
fi

# Get the command and arg_prompt for selected app
COMMAND=$(jq -r --arg name "$SELECTED" '.apps[] | select(.name == $name) | .command' "$CONFIG_FILE")
ARG_PROMPT=$(jq -r --arg name "$SELECTED" '.apps[] | select(.name == $name) | .arg_prompt // empty' "$CONFIG_FILE")

# If arg_prompt exists, prompt the user
if [ -n "$ARG_PROMPT" ]; then
    read -rp "$ARG_PROMPT: " ARG
    exec $COMMAND "$ARG"
else
    exec $COMMAND
fi
